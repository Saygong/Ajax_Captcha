<html lang="en">

    <head>
        <title>Introduzione a AJAX</title>
        <script src="jquery.min.js"></script>
        <script>
            error = false;

            function addError(text){
                if (!error) {
                    error = true;
                    $(document.body).append("<div id='error'>" + text + "</div>");
                }
                else {
                    $('#error').remove();
                    $(document.body).append("<div id='error'>" + text + "</div>");
                }
            }



            function getSession(){

                return $.ajax({
                    type:'GET',
                    url: 'http://www.dais.unive.it/~cosmo/teaching/esercitazione3/captcha.php?callback=?&getIdentifier',
                    dataType: 'json',
                }).done( function(data){

                    return $.ajax({
                        type:'GET',
                        url: 'http://www.dais.unive.it/~cosmo/teaching/esercitazione3/captcha.php?callback=?&getImage&id=' + data.id,
                        dataType: 'json',
                    }).done( function(img){

                        let path = "http://www.dais.unive.it/~cosmo/teaching/esercitazione3/" + img.url;
                        $("#captcha").attr("src", path);
                        return img.id;

                    }).fail(function(error){
                        addError("Errore: " + JSON.stringify(error));
                    });

                }).fail(function(error){
                    addError("Errore: " + JSON.stringify(error));
                });

            }


            function authenticated(){
                $(document.body).empty();

                $(document.body).append("<div id='auth'></div>");
                $("#auth").css({
                    "width": "50%",
                    "margin": "0 auto",
                    "text-align": "center",
                    "border": "1px solid gray",
                    "margin-top": "10%"
                });

                $("#auth").append("<h1 id='auth_text'>Successfully authenticated!</h1>");
                $("#auth_text").css("text-decoration","underline");
            }


            function checking(user_input, sessionId){
                return $.ajax({
                    type: 'GET',
                    dataType: "json",
                    url: "http://www.dais.unive.it/~cosmo/teaching/esercitazione3/captcha.php?callback=?&sendCode&id=" + sessionId + "&code=" + user_input,
                }).done(function (data) {
                    return data.auth;

                }).fail(function(error){
                    addError("Errore: " + JSON.stringify(error));
                });

            }

             function mainFunc() {

                 getSession().done( function (data) {
                     let sessionId = data.id;

                     let buttonclick = $.Deferred();

                     $("#ok").click(function () {

                         buttonclick.resolve();

                         let user_input = $("#captcha_code").val();
                         if (user_input !== "") {

                             checking(user_input, sessionId).done(function (data) {
                                 if (data.auth) {
                                     authenticated();
                                 } else {
                                     addError("Codice errato!");
                                     mainFunc();
                                 }
                             }).fail(function(error){
                                 console.log("Errore: " + error);

                             });
                         } else {
                             addError("Inserire un valore");
                             mainFunc()
                         }
                     });

                 }).fail(function(error){
                     console.log("Errore: " + error);
                 });

             }

            $(document).ready(mainFunc());

        </script>
        <style>
            img {
                width: 215px;
                height: 80px;
            }
        </style>

    </head>
<body>
    
    <!--Il corpo della pagina HTML non deve essere modificato -->
    <img id='captcha' /><br/>
    <input type='text' id='captcha_code'/>
    <button id="ok">OK</button>
	   
</body>